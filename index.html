<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SITARLAUT 3D — Sistem Informasi Tata Ruang Laut</title>

<!-- CesiumJS 1.135 (biar cocok dengan contoh tileset-mu) -->
<link href="https://cesium.com/downloads/cesiumjs/releases/1.135/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
<script src="https://cesium.com/downloads/cesiumjs/releases/1.135/Build/Cesium/Cesium.js"></script>

<style>
  :root{
    --bg:#0b1220; --panel:#0f1a2b; --border:#1f2d44; --text:#e6eef9; --muted:#97a6bf;
    --brand:#0c5adb; --brand-2:#0e7fff; --accent:#1e90ff;
  }
  html,body,#map{height:100%;margin:0;background:var(--bg);font:14px/1.4 "Inter",system-ui,Segoe UI,Roboto,Arial,sans-serif}
  #govbar{position:absolute; top:0; left:0; right:0; height:56px; z-index:12; display:flex; align-items:center; gap:10px; padding:0 16px;
    background:linear-gradient(90deg, var(--brand) 0%, var(--brand-2) 100%); color:white; box-shadow:0 2px 10px rgba(0,0,0,.25)}
  #govbar img{height:30px} #govbar h1{font-size:16px;margin:0;font-weight:800} #govbar small{opacity:.9;display:block;font-weight:500}
  #ui{position:absolute; top:68px; left:16px; z-index:10; width:420px; max-height:calc(100% - 84px);
    background:#0b1220cc; border:1px solid var(--border); border-radius:14px; backdrop-filter: blur(6px);
    color:var(--text); overflow:auto; box-shadow:0 8px 28px rgba(0,0,0,.35)}
  .tabs{display:flex; gap:6px; padding:10px 12px; border-bottom:1px solid var(--border)}
  .tab{flex:1; text-align:center; padding:8px 10px; border-radius:10px; cursor:pointer; background:#0e1830; color:#cfe3ff; border:1px solid #182746; font-weight:700}
  .tab.active{background:#14325c; border-color:#224e88}
  .section{padding:12px 14px; border-bottom:1px solid var(--border)}
  .section h2{font-size:14px; margin:0 0 6px; color:#cfe3ff}
  .sub{color:var(--muted); font-size:12px; margin-bottom:6px}
  .tog{display:flex; align-items:center; gap:10px; margin:8px 0}
  input,select,button{width:100%; padding:8px 10px; border-radius:10px; border:1px solid #20324d; background:#0f1a2b; color:var(--text)}
  button{cursor:pointer; background:var(--accent); border:0; font-weight:800}
  .btn-ghost{background:#112038; border:1px solid #20324d}
  .row{display:flex; gap:8px} .row>*{flex:1}
  .note{font-size:12px; color:var(--muted)}
  #status{position:absolute; right:16px; bottom:16px; z-index:5; color:var(--text); background:#0b1220cc; border:1px solid var(--border); border-radius:12px; padding:8px 12px; max-width:520px; font-size:12px}
  /* Tabel AIS */
  table{width:100%; border-collapse:collapse; margin-top:8px; font-size:13px}
  thead th{position:sticky; top:0; background:#0f2039; border-bottom:1px solid var(--border); text-align:left; padding:8px}
  tbody td{border-bottom:1px solid #16243b; padding:6px 8px}
  tbody tr:hover{background:#0e1830}
  .btn-mini{padding:6px 8px; font-weight:700; border-radius:8px}
</style>
</head>
<body>
<div id="map"></div>

<!-- Header -->
<div id="govbar">
  <img src="https://cdn.jsdelivr.net/gh/tabler/tabler-icons/icons/shield.svg" alt="">
  <div>
    <h1>Ocean Monitoring System</h1>
  </div>
</div>

<!-- Sidebar -->
<div id="ui" role="region" aria-label="Panel Pengaturan">
  <div class="tabs" role="tablist">
    <div class="tab active" id="tabLayers">Layer</div>
    <div class="tab" id="tabData">Data</div>
    <div class="tab" id="tabTentang">Tentang</div>
  </div>

  <!-- LAYER -->
  <div id="paneLayers" class="section">
    <h2>Lapisan Peta</h2>
    <div class="sub">Fokus Indonesia; gunakan fly untuk melihat gedung & kapal.</div>

    <div class="row">
      <div>
        <label>Fly to pelabuhan</label>
        <select id="flyTo">
          <option value="priok">Jakarta – Tanjung Priok</option>
          <option value="perak">Surabaya – Tanjung Perak</option>
          <option value="makassar">Makassar – Soekarno Hatta</option>
          <option value="balikpapan">Balikpapan</option>
        </select>
      </div>
      <div style="align-self:end"><button id="flyBtn">Fly</button></div>
    </div>

    <div class="tog">
      <input type="checkbox" id="togBuildings" checked />
      <label for="togBuildings">Gedung 3D — Building Tileset (OSM)</label>
    </div>

    <div class="tog">
      <input type="checkbox" id="togAIS" />
      <label for="togAIS">Posisi Kapal (AIS — ikon Flaticon + label + tabel)</label>
    </div>
  </div>

  <!-- DATA -->
  <div id="paneData" class="section" hidden>
    <h2>Data</h2>
    <div id="aisRealtime">
      <h3 style="font-size:13px;margin:0 0 6px;color:#bcd6ff">AIS — Tabel Realtime</h3>
      <p class="note">Klik <b>Lihat</b> untuk terbang ke kapal.</p>
      <div style="max-height:260px; overflow:auto; border:1px solid var(--border); border-radius:10px">
        <table>
          <thead><tr><th>Nama</th><th>Jenis</th><th>Speed</th><th>Aksi</th></tr></thead>
          <tbody id="aisTableBody"><tr><td colspan="4" class="note" style="padding:10px">Belum aktif. Centang “Posisi Kapal (AIS)”.</td></tr></tbody>
        </table>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="btnAisFlyAll" class="btn-ghost">Fly ke Area AIS</button>
        <button id="btnAisStop" class="btn-ghost">Matikan AIS</button>
      </div>
    </div>
  </div>

  <!-- TENTANG -->
  <div id="paneTentang" class="section" hidden>
    <h2>Tentang</h2>
    <p class="note">SITARLAUT 3D: integrasi building tileset + AIS dengan fokus Indonesia.</p>
  </div>
</div>

<div id="status" role="status" aria-live="polite">Status: memuat…</div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const setStatus = (t)=>{ $('status').textContent = 'Status: ' + t; console.log('[SITARLAUT]', t); };

  // === Ion token (ganti dengan yang berakses OSM Buildings bila perlu)
  Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI4MGZjYmVlNC01MDEwLTQ3M2ItYTU0Mi00NTljZDMwYTdhYTMiLCJpZCI6NzU1MiwiaWF0IjoxNzYyMjY3NjI0fQ._x11gbiK3ozL9DYz1WVGQDruICGCuTuhZXAglQQh7ZQ';

  // ===== Viewer
  const viewer = new Cesium.Viewer('map', {
    terrain: Cesium.Terrain.fromWorldTerrain(),
    animation:false, timeline:false, geocoder:true, baseLayerPicker:false, sceneModePicker:true,
    infoBox:true, selectionIndicator:true
  });
  viewer.scene.globe.depthTestAgainstTerrain = false;

  // Fokus Indonesia
  viewer.camera.setView({ destination: Cesium.Cartesian3.fromDegrees(117.0, -2.0, 5_000_000) });

  // ===== Building tileset (OSM 3D Tiles) — fokus Indonesia
  let buildings = null;
  (async () => {
    try{
      buildings = await Cesium.createOsmBuildingsAsync(); // tileset
      viewer.scene.primitives.add(buildings);
      setStatus('Building tileset aktif. Fly ke pelabuhan untuk melihat detail.');
    }catch(e){
      setStatus('Gagal memuat building tileset (cek token Ion/akses).');
      console.warn(e);
      $('togBuildings').checked = false;
    }
  })();

  $('togBuildings').addEventListener('change', e=>{
    if (!buildings) { e.target.checked=false; return; }
    buildings.show = e.target.checked;
    setStatus('Building tileset: ' + (buildings.show? 'ON':'OFF'));
  });

  // Preset fly Indonesia
  const FLY = {
    priok:      {lon:106.884, lat:-6.109, h:2200},
    perak:      {lon:112.737, lat:-7.200, h:2200},
    makassar:   {lon:119.418, lat:-5.125, h:2200},
    balikpapan: {lon:116.85,  lat:-1.27,  h:2400}
  };
  $('flyBtn').onclick = ()=>{
    const t = FLY[$('flyTo').value] || FLY.priok;
    viewer.camera.flyTo({
      destination: Cesium.Cartesian3.fromDegrees(t.lon, t.lat, t.h),
      orientation: { heading: 0, pitch: Cesium.Math.toRadians(-20) },
      duration: 1.4
    });
  };

  // ===== Tabs
  [['tabLayers','paneLayers'],['tabData','paneData'],['tabTentang','paneTentang']].forEach(([tab,pane])=>{
    $(tab).onclick = ()=>{
      ['paneLayers','paneData','paneTentang'].forEach(p=>$(p).hidden = p!==pane);
      ['tabLayers','tabData','tabTentang'].forEach(t=>$(t).classList.toggle('active', t===tab));
    };
  });

  // ===== AIS (ikon Flaticon + label + tabel)
  // URL dari Flaticon (halaman) biasanya bukan URL gambar langsung.
  // Kita preload: jika gagal (CORS/hotlink), fallback ke SVG data-URI supaya tetap tampil.
  const SHIP_ICON_PAGE = 'https://www.flaticon.com/free-icon/transport_10956885?term=ship&page=4&position=21&origin=tag&related_id=10956885';
  // Opsional: isi dengan URL PNG langsung (lebih aman) jika kamu punya:
  const SHIP_ICON_DIRECT = ''; // contoh: 'https://cdn-icons-png.flaticon.com/512/10956/10956885.png'

  const SHIP_FALLBACK_SVG =
    'data:image/svg+xml;utf8,' +
    encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
      <path d="M8 38l24-10 24 10-6 16H14L8 38z" fill="#1e90ff"/>
      <path d="M32 10l10 16H22L32 10z" fill="#0c5adb"/>
    </svg>`);

  let shipImage = null;
  function preloadShipIcon(){
    return new Promise(res=>{
      const tryUrl = SHIP_ICON_DIRECT || SHIP_ICON_PAGE;
      const img = new Image();
      img.crossOrigin = "anonymous";
      img.onload = ()=>{ shipImage = img; res(true); };
      img.onerror = ()=>{
        const fb = new Image();
        fb.src = SHIP_FALLBACK_SVG;
        fb.onload = ()=>{ shipImage = fb; res(false); };
        fb.onerror = ()=>{ shipImage = null; res(false); };
      };
      img.src = tryUrl;
    });
  }

  let aisTimer=null, aisBillboards=null, aisHasFlown=false, aisSelection=null;
  let DEMO_SHIPS = [];
  const CLUSTERS = [
    { name:'Balikpapan', lon:116.85,  lat:-1.27,  spreadKm:20, count:12 },
    { name:'Tj. Priok',  lon:106.884, lat:-6.109, spreadKm:15, count:12 },
    { name:'Tj. Perak',  lon:112.737, lat:-7.200, spreadKm:15, count:12 },
    { name:'Makassar',   lon:119.418, lat:-5.125, spreadKm:15, count:12 }
  ];
  function degPerKmLat(){ return 1/110.574; }
  function degPerKmLon(latDeg){ return 1/(111.320 * Math.cos(latDeg*Math.PI/180)); }
  function rrand(a,b){ return a + Math.random()*(b-a); }

  function seedDemoShips(){
    const types = ['tanker','cargo','fishing','passenger'];
    DEMO_SHIPS = [];
    for (const c of CLUSTERS){
      const dLat = degPerKmLat(), dLon = degPerKmLon(c.lat);
      for (let i=0;i<c.count;i++){
        const r = c.spreadKm * Math.sqrt(Math.random());
        const t = Math.random()*Math.PI*2;
        const offLat = r * Math.sin(t) * dLat;
        const offLon = r * Math.cos(t) * dLon;
        const type = types[Math.floor(Math.random()*types.length)];
        DEMO_SHIPS.push({
          id:`${c.name.replace(/\s+/g,'_')}_${i+1}`,
          name:`${c.name} #${String(i+1).padStart(2,'0')}`,
          type, lon:c.lon + offLon, lat:c.lat + offLat,
          course: Math.random()*360, speed: rrand(6,15)
        });
      }
    }
  }
  function updateShipMotion(){
    const dt = 2;
    DEMO_SHIPS = DEMO_SHIPS.map(v=>{
      const kmps = (v.speed * 1.852) / 3600;
      const dist = kmps * dt;
      const dir = v.course * Math.PI/180;
      const dNorth = Math.cos(dir)*dist, dEast = Math.sin(dir)*dist;
      const dLat = dNorth * degPerKmLat(), dLon = dEast * degPerKmLon(v.lat);
      return {...v, lon: v.lon + dLon, lat: v.lat + dLat, course: (v.course + rrand(-2,2)+360)%360};
    });
  }

  function ensureAisLayer(){
    if (!aisBillboards) aisBillboards = viewer.scene.primitives.add(new Cesium.BillboardCollection());
    if (!viewer.entities._aisLabelsGroup) viewer.entities._aisLabelsGroup = [];
  }
  function clearAisLabels(){
    const g = viewer.entities._aisLabelsGroup || [];
    for (const e of g) viewer.entities.remove(e);
    viewer.entities._aisLabelsGroup = [];
  }

  function drawShips(ships){
    ensureAisLayer();
    aisBillboards.removeAll();
    clearAisLabels();
    for (const v of ships){
      aisBillboards.add({
        position: Cesium.Cartesian3.fromDegrees(v.lon, v.lat),
        image: shipImage || SHIP_FALLBACK_SVG,
        scale: 0.09,
        verticalOrigin: Cesium.VerticalOrigin.CENTER,
        horizontalOrigin: Cesium.HorizontalOrigin.CENTER,
        disableDepthTestDistance: Number.POSITIVE_INFINITY
      });
      const label = viewer.entities.add({
        position: Cesium.Cartesian3.fromDegrees(v.lon, v.lat, 5),
        label: {
          text: `${v.name} • ${v.type} • ${v.speed.toFixed(0)} kts`,
          font: '12px sans-serif',
          pixelOffset: new Cesium.Cartesian2(0, -28),
          fillColor: Cesium.Color.WHITE,
          outlineColor: Cesium.Color.BLACK,
          outlineWidth: 2,
          style: Cesium.LabelStyle.FILL_AND_OUTLINE,
          disableDepthTestDistance: Number.POSITIVE_INFINITY,
          showBackground: true,
          backgroundColor: new Cesium.Color(0,0,0,0.5),
          backgroundPadding: new Cesium.Cartesian2(6,4)
        }
      });
      viewer.entities._aisLabelsGroup.push(label);
    }
  }

  function renderAisTable(ships){
    const tb = $('aisTableBody');
    tb.innerHTML = (ships && ships.length)
      ? ships.map(s=>`
        <tr>
          <td>${s.name}</td><td>${s.type}</td><td>${s.speed.toFixed(0)} kts</td>
          <td><button class="btn-mini btn-ghost" data-goto="${s.id}">Lihat</button></td>
        </tr>`).join('')
      : `<tr><td colspan="4" class="note" style="padding:10px">Tidak ada data AIS.</td></tr>`;
  }

  function highlightSelection(lon, lat){
    if (aisSelection) { viewer.entities.remove(aisSelection); aisSelection=null; }
    aisSelection = viewer.entities.add({
      position: Cesium.Cartesian3.fromDegrees(lon, lat, 2),
      point: { pixelSize:10, color: Cesium.Color.CHARTREUSE, outlineColor: Cesium.Color.BLACK, outlineWidth:2 }
    });
  }
  function focusShip(ship){
    viewer.camera.flyTo({ destination: Cesium.Cartesian3.fromDegrees(ship.lon, ship.lat, 1200), duration: 1.1, orientation:{pitch: Cesium.Math.toRadians(-25)} });
    highlightSelection(ship.lon, ship.lat);
    setStatus(`Memantau: ${ship.name} (${ship.type}) • ${ship.speed.toFixed(0)} kts`);
  }
  function flyToAISExtent(ships){
    let minLon=+Infinity, minLat=+Infinity, maxLon=-Infinity, maxLat=-Infinity;
    for (const s of ships){ minLon=Math.min(minLon,s.lon); maxLon=Math.max(maxLon,s.lon); minLat=Math.min(minLat,s.lat); maxLat=Math.max(maxLat,s.lat); }
    const rect = Cesium.Rectangle.fromDegrees(minLon, minLat, maxLon, maxLat);
    viewer.camera.flyTo({ destination: rect, duration: 1.2 });
  }

  async function fetchAISOnce(){
    updateShipMotion();
    drawShips(DEMO_SHIPS);
    renderAisTable(DEMO_SHIPS);
    if (!aisHasFlown && DEMO_SHIPS.length){ aisHasFlown = true; flyToAISExtent(DEMO_SHIPS); }
  }
  async function startAIS(){
    await preloadShipIcon();            // muat ikon flaticon (atau fallback)
    seedDemoShips();
    fetchAISOnce();
    stopAIS();                          // bersihkan interval lama jika ada
    aisTimer = setInterval(fetchAISOnce, 2000);
    $('togAIS').checked = true;
    setStatus('AIS berjalan (ikon Flaticon).');
  }
  function stopAIS(){
    if (aisTimer){ clearInterval(aisTimer); aisTimer=null; }
    if (aisBillboards){ aisBillboards.removeAll(); }
    clearAisLabels();
    if (aisSelection){ viewer.entities.remove(aisSelection); aisSelection=null; }
    renderAisTable([]);
    $('togAIS').checked = false;
    setStatus('AIS dimatikan.');
  }

  // Toggle AIS + tabel actions
  $('togAIS').addEventListener('change', e=> e.target.checked ? startAIS() : stopAIS());
  $('btnAisFlyAll').onclick = ()=>{ if (DEMO_SHIPS.length) flyToAISExtent(DEMO_SHIPS); };
  $('btnAisStop').onclick = ()=> stopAIS();
  $('aisTableBody').addEventListener('click', (ev)=>{
    const btn = ev.target.closest('[data-goto]'); if (!btn) return;
    const id = btn.getAttribute('data-goto');
    const ship = DEMO_SHIPS.find(s=>s.id===id); if (ship) focusShip(ship);
  });

  // Info awal
  setStatus('Siap. Building tileset ON. Aktifkan AIS untuk ikon Flaticon.');
})();
</script>
</body>
</html>
