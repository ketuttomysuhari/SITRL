<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SITARLAUT 3D — Sistem Informasi Tata Ruang Laut (CesiumJS)</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cesium@1.120/Build/Cesium/Widgets/widgets.css"/>
<script src="https://cdn.jsdelivr.net/npm/cesium@1.120/Build/Cesium/Cesium.js"></script>
<style>
  :root{
    --bg:#0b0f14; --panel:#0f1621; --border:#1f2733; --text:#e7eef8; --muted:#94a3b8; --accent:#2e8fff;
  }
  html,body,#map{height:100%;margin:0;background:var(--bg)}
  #ui{
    position:absolute; top:12px; right:12px; z-index:10; width:360px; max-height:calc(100% - 24px);
    background:#0b0f14cc; color:var(--text); border:1px solid var(--border); border-radius:14px;
    font:14px/1.4 system-ui,Segoe UI,Roboto,Arial,sans-serif; backdrop-filter: blur(6px); overflow:auto;
  }
  #ui header{padding:14px 14px 10px; border-bottom:1px solid var(--border)}
  #ui header h1{font-size:16px; margin:0 0 4px}
  #ui header small{color:var(--muted)}
  #ui section{padding:12px 14px; border-bottom:1px solid var(--border)}
  #ui details{border:1px solid var(--border); border-radius:10px; padding:8px; margin-top:8px}
  #ui summary{cursor:pointer; color:#a6d3ff; font-weight:700}
  label{display:block; margin:6px 0 2px}
  input,select,textarea{
    width:100%; padding:6px 8px; border-radius:8px; border:1px solid #263142; background:#0f141b; color:var(--text);
  }
  button{
    width:100%; margin-top:8px; padding:9px 10px; border-radius:10px; border:0; cursor:pointer; background:var(--accent); color:white; font-weight:800;
  }
  .btn-secondary{background:#334155}
  .row{display:flex; gap:8px}
  .row>*{flex:1}
  .tog{display:flex; align-items:center; gap:8px; margin:6px 0}
  .pill{display:inline-block; padding:2px 8px; border:1px solid var(--border); border-radius:999px; color:var(--muted); font-size:12px}
  #status{
    position:absolute; left:12px; bottom:12px; z-index:5; color:var(--text); background:#0b0f14cc;
    border:1px solid var(--border); border-radius:12px; padding:8px 12px; max-width:520px; font:12px system-ui,Segoe UI,Roboto,Arial,sans-serif;
  }
  a.link{color:#9ad1ff; text-decoration:none}
</style>
</head>
<body>
<div id="map"></div>

<div id="ui">
  <header>
    <h1>SITARLAUT 3D</h1>
    <small>Sistem Informasi Tata Ruang Laut — Digital Twin</small><br/>
    <span class="pill">CesiumJS</span> <span class="pill">GFW</span> <span class="pill">Copernicus Marine</span> <span class="pill">MarineTraffic</span>
  </header>

  <section>
    <div class="tog">
      <input type="checkbox" id="togOSMB" />
      <label for="togOSMB">OSM Buildings (gedung 3D pesisir & pelabuhan)</label>
    </div>
    <div class="tog">
      <input type="checkbox" id="togGFW" />
      <label for="togGFW">Global Fishing Watch — heatmap aktivitas</label>
    </div>
    <div class="tog">
      <input type="checkbox" id="togAIS" />
      <label for="togAIS">MarineTraffic — demo kapal (data contoh)</label>
    </div>
    <div class="tog">
      <input type="checkbox" id="togMSP" />
      <label for="togMSP">Zonasi Tata Ruang Laut (GeoJSON)</label>
    </div>
  </section>

  <section>
    <details open>
      <summary>Token & Kunci</summary>
      <label>Cesium ion token</label>
      <input id="ionToken" value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI4MGZjYmVlNC01MDEwLTQ3M2ItYTU0Mi00NTljZDMwYTdhYTMiLCJpZCI6NzU1MiwiaWF0IjoxNzYyMjY3NjI0fQ._x11gbiK3ozL9DYz1WVGQDruICGCuTuhZXAglQQh7ZQ"/>
      <button id="applyToken">Terapkan Token</button>
    </details>

    <details>
      <summary>Global Fishing Watch</summary>
      <label>Preset heatmap</label>
      <select id="gfwPreset">
        <option value="https://tiles.globalfishingwatch.org/heatmap/fishing/v1/{z}/{x}/{y}.png">Fishing effort (v1) — demo</option>
      </select>
      <label>URL Tile (XYZ)</label>
      <input id="gfwTileUrl" placeholder="https://tiles.../{z}/{x}/{y}.png?token=..." />
      <button id="gfwAdd">Aktifkan / Ganti Layer</button>
    </details>

    <details>
      <summary>Copernicus Marine (WMS/WMTS)</summary>
      <label>Preset</label>
      <select id="cmemsPreset">
        <option value="">— pilih preset —</option>
        <!-- Preset umum (contoh). Harap sesuaikan layer name dari GetCapabilities -->
        <option value='{"url":"https://my.cmems-du.eu/thredds/wms/METOFFICE-GLO-PHYS-FCST-SEA_SURFACE_HEIGHT-LATEST","layer":"zos","fmt":"image/png"}'>
          Sea Surface Height (METOFFICE) — layer: zos
        </option>
        <option value='{"url":"https://my.cmems-du.eu/thredds/wms/GLO_PHY_MY_001_030-TDS","layer":"thetao","fmt":"image/png"}'>
          Temperature (reanalysis) — layer: thetao
        </option>
      </select>
      <div class="row">
        <div>
          <label>URL WMS/WMTS</label>
          <input id="wmsUrl" placeholder="https://.../wms atau .../wmts"/>
        </div>
      </div>
      <label>Layer name</label>
      <input id="wmsLayer" placeholder="contoh: zos / thetao / uo / vo"/>
      <div class="row">
        <div><label>Format</label>
          <select id="wmsFmt">
            <option value="image/png">image/png (transparan)</option>
            <option value="image/jpeg">image/jpeg</option>
          </select>
        </div>
        <div>
          <label>Opacity</label>
          <input id="wmsAlpha" type="number" min="0" max="1" step="0.1" value="0.8"/>
        </div>
      </div>
      <button id="wmsAdd">Tambah / Ganti Layer</button>
      <button id="wmsClear" class="btn-secondary">Hapus Semua WMS</button>
    </details>

    <details>
      <summary>MarineTraffic (AIS)</summary>
      <p style="margin:6px 0 8px;color:var(--muted)">Demo menampilkan kapal contoh + placeholder untuk API resmi.</p>
      <label>API endpoint (opsional, kalau punya lisensi)</label>
      <input id="mtUrl" placeholder="https://services.marinetraffic.com/api/.../YOUR_KEY?params=..."/>
      <div class="row">
        <div>
          <label>Interval (detik)</label>
          <input id="mtEvery" type="number" min="5" value="60"/>
        </div>
        <div>
          <label>Durasi (menit)</label>
          <input id="mtMinutes" type="number" min="1" value="10"/>
        </div>
      </div>
      <button id="mtStart">Mulai Tracking</button>
      <button id="mtStop" class="btn-secondary">Stop</button>
    </details>

    <details>
      <summary>Zonasi (GeoJSON)</summary>
      <label>GeoJSON URL</label>
      <input id="mspUrl" placeholder="https://server/zonasi_msp.geojson"/>
      <button id="mspLoad">Muat Zonasi</button>
      <button id="mspClear" class="btn-secondary">Hapus</button>
    </details>
  </section>

  <section>
    <details>
      <summary>Tentang</summary>
      <p>Platform 3D untuk perencanaan & monitoring tata ruang laut: overlay zonasi, aktivitas perikanan, parameter oseanografi, dan kapal. Siap untuk konsep <b>Digital Twin</b> berbasis waktu.</p>
      <p>Tips: gunakan <a class="link" target="_blank" href="https://data.marine.copernicus.eu">Copernicus Marine</a> GetCapabilities untuk mencari <i>layer name</i>.</p>
    </details>
  </section>
</div>

<div id="status">Status: siap</div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const setStatus = (t)=>{ $('status').textContent = 'Status: ' + t; console.log('[SITARLAUT]', t); };

  // ——— Init Cesium ———
  let viewer, osmBuildings, gfwLayer, mspDS, aisBillboards=null, aisTimer=null, wmsLayers=[];
  function boot(){
    const token = $('ionToken').value.trim();
    if (token) Cesium.Ion.defaultAccessToken = token;

    viewer = new Cesium.Viewer('map',{
      animation:false, timeline:false, geocoder:true, baseLayerPicker:true, sceneModePicker:true,
      terrain: Cesium.Terrain.fromWorldTerrain(),
      infoBox:true, selectionIndicator:true
    });

    // Nice defaults: fly to Indonesia center-ish
    viewer.camera.flyTo({
      destination: Cesium.Cartesian3.fromDegrees(117, -2, 3_500_000),
      duration: 1.5
    });

    // Wire toggles
    $('togOSMB').addEventListener('change', onToggleOSMB);
    $('togGFW').addEventListener('change', onToggleGFW);
    $('togAIS').addEventListener('change', onToggleAIS);
    $('togMSP').addEventListener('change', onToggleMSP);

    // Buttons
    $('applyToken').onclick = ()=>{ Cesium.Ion.defaultAccessToken = $('ionToken').value.trim(); alert('Token diterapkan. Reload bila perlu.'); };
    $('gfwAdd').onclick = enableOrSwapGFW;
    $('wmsAdd').onclick = addWMS;
    $('wmsClear').onclick = clearWMS;

    $('mtStart').onclick = startAIS;
    $('mtStop').onclick = stopAIS;

    $('mspLoad').onclick = loadMSP;
    $('mspClear').onclick = clearMSP;

    // Presets
    $('gfwPreset').onchange = ()=>{ $('gfwTileUrl').value = $('gfwPreset').value; };
    $('cmemsPreset').onchange = ()=>{
      const v = $('cmemsPreset').value;
      if (!v) return;
      try{
        const p = JSON.parse(v);
        $('wmsUrl').value = p.url||'';
        $('wmsLayer').value = p.layer||'';
        $('wmsFmt').value = p.fmt||'image/png';
      }catch(e){}
    };

    setStatus('Siap: setel layer pada panel kanan.');
  }

  // ——— OSM Buildings ———
  function onToggleOSMB(e){
    if (e.target.checked){
      if (!osmBuildings){
        osmBuildings = Cesium.createOsmBuildings();
      }
      viewer.scene.primitives.add(osmBuildings);
      setStatus('OSM Buildings: ON');
    }else{
      if (osmBuildings) viewer.scene.primitives.remove(osmBuildings);
      setStatus('OSM Buildings: OFF');
    }
  }

  // ——— GFW ———
  function enableOrSwapGFW(){
    const url = $('gfwTileUrl').value.trim() || $('gfwPreset').value;
    if (!url){ alert('Isi URL tile XYZ GFW.'); return; }
    if (gfwLayer){
      // swap
      try{ viewer.imageryLayers.remove(gfwLayer); }catch(e){}
      gfwLayer = null;
    }
    const prov = new Cesium.UrlTemplateImageryProvider({ url, minimumLevel:0, maximumLevel:12, credit:'Global Fishing Watch' });
    gfwLayer = viewer.imageryLayers.addImageryProvider(prov);
    gfwLayer.alpha = 0.75;
    $('togGFW').checked = true;
    setStatus('GFW heatmap aktif.');
  }
  function onToggleGFW(e){
    if (e.target.checked){
      if (!gfwLayer) enableOrSwapGFW();
      else setStatus('GFW heatmap aktif.');
    }else{
      if (gfwLayer){ viewer.imageryLayers.remove(gfwLayer); gfwLayer=null; }
      setStatus('GFW heatmap dimatikan.');
    }
  }

  // ——— Copernicus Marine (WMS/WMTS) ———
  function addWMS(){
    const url = $('wmsUrl').value.trim();
    const layer = $('wmsLayer').value.trim();
    const fmt = $('wmsFmt').value;
    const alpha = Math.min(1, Math.max(0, parseFloat($('wmsAlpha').value||'0.8')));

    if (!url || !layer){ alert('Isi URL WMS/WMTS dan layer name.'); return; }

    try{
      let prov;
      if (/wmts/i.test(url)){
        // Heuristik sederhana untuk WMTS — sesuaikan tileMatrixSetID bila perlu
        prov = new Cesium.WebMapTileServiceImageryProvider({
          url, layer, style:'default', tileMatrixSetID:'EPSG:3857', format:fmt,
          tilingScheme: new Cesium.WebMercatorTilingScheme()
        });
      }else{
        prov = new Cesium.WebMapServiceImageryProvider({
          url, layers: layer, parameters:{transparent:true, format:fmt, tiled:true}
        });
      }
      const lyr = viewer.imageryLayers.addImageryProvider(prov);
      lyr.alpha = alpha;
      wmsLayers.push(lyr);
      setStatus('Layer Copernicus ditambahkan.');
    }catch(e){
      console.error(e);
      alert('Gagal menambahkan WMS/WMTS. Cek URL / layer / hak akses.');
    }
  }
  function clearWMS(){
    for (const lyr of wmsLayers){
      try{ viewer.imageryLayers.remove(lyr); }catch(e){}
    }
    wmsLayers = [];
    setStatus('Semua layer WMS/WMTS dihapus.');
  }

  // ——— MarineTraffic (AIS) ———
  const DEMO_SHIPS = [
    // Contoh statis di perairan Indonesia (koordinat perkiraan)
    { name:'KM Nusantara', lon:117.1, lat:-0.8, course:45, speed:12 },
    { name:'MV Samudra',   lon:115.9, lat:-1.5, course:90, speed:10 },
    { name:'MT LautBirU',  lon:119.2, lat:-2.1, course:12, speed:14 }
  ];
  function onToggleAIS(e){
    if (e.target.checked){
      startAIS();
    }else{
      stopAIS();
    }
  }
  function ensureAisLayer(){
    if (!aisBillboards){
      aisBillboards = viewer.scene.primitives.add(new Cesium.BillboardCollection());
    }
  }
  async function fetchAISOnce(){
    const url = $('mtUrl').value.trim();
    ensureAisLayer();
    aisBillboards.removeAll();

    if (!url){
      // Demo: tampilkan kapal statis
      for (const v of DEMO_SHIPS){
        aisBillboards.add({
          position: Cesium.Cartesian3.fromDegrees(v.lon, v.lat),
          image: 'https://cdn.jsdelivr.net/gh/tabler/tabler-icons/icons/ship.svg',
          scale: 0.7,
          disableDepthTestDistance: Number.POSITIVE_INFINITY
        });
      }
      setStatus('Demo AIS: 3 kapal contoh ditampilkan.');
      return;
    }

    try{
      const res = await fetch(url);
      if (!res.ok) throw new Error('AIS fetch gagal: ' + res.status);
      const data = await res.json();
      const arr = Array.isArray(data) ? data : (data?.data || []);
      for (const v of arr){
        const lon = +v.lon || +v.LONGITUDE || +v.longitude;
        const lat = +v.lat || +v.LATITUDE || +v.latitude;
        if (isFinite(lon) && isFinite(lat)){
          aisBillboards.add({
            position: Cesium.Cartesian3.fromDegrees(lon, lat),
            image: 'https://cdn.jsdelivr.net/gh/tabler/tabler-icons/icons/ship.svg',
            scale: 0.7,
            disableDepthTestDistance: Number.POSITIVE_INFINITY
          });
        }
      }
      setStatus(`AIS: ${arr.length} kapal ditampilkan.`);
    }catch(e){
      console.error(e);
      setStatus('Gagal mengambil AIS dari endpoint. Menampilkan demo kapal.');
      // fallback demo
      for (const v of DEMO_SHIPS){
        aisBillboards.add({
          position: Cesium.Cartesian3.fromDegrees(v.lon, v.lat),
          image: 'https://cdn.jsdelivr.net/gh/tabler/tabler-icons/icons/ship.svg',
          scale: 0.7
        });
      }
    }
  }
  function startAIS(){
    fetchAISOnce(); // first
    const every = Math.max(5, parseInt($('mtEvery').value||'60',10));
    stopAIS();
    aisTimer = setInterval(fetchAISOnce, every*1000);
    $('togAIS').checked = true;
    setStatus('AIS tracking berjalan.');
  }
  function stopAIS(){
    if (aisTimer){ clearInterval(aisTimer); aisTimer=null; }
    if (aisBillboards){ aisBillboards.removeAll(); }
    $('togAIS').checked = false;
    setStatus('AIS tracking dihentikan.');
  }

  // ——— Zonasi MSP (GeoJSON) ———
  async function loadMSP(){
    const url = $('mspUrl').value.trim();
    if (!url){ alert('Isi URL GeoJSON zonasi.'); return; }
    try{
      if (mspDS){ viewer.dataSources.remove(mspDS); mspDS=null; }
      mspDS = await Cesium.GeoJsonDataSource.load(url,{
        clampToGround:true,
        stroke: Cesium.Color.CYAN.withAlpha(0.9),
        fill:   Cesium.Color.CYAN.withAlpha(0.18),
        strokeWidth:2
      });
      viewer.dataSources.add(mspDS);
      viewer.flyTo(mspDS);
      $('togMSP').checked = true;
      setStatus('Zonasi MSP dimuat.');
    }catch(e){
      console.error(e);
      alert('Gagal memuat GeoJSON. Pastikan CORS/URL valid.');
    }
  }
  function clearMSP(){
    if (mspDS){ viewer.dataSources.remove(mspDS); mspDS=null; }
    $('togMSP').checked = false;
    setStatus('Zonasi MSP dihapus.');
  }
  function onToggleMSP(e){
    if (e.target.checked){
      if (!mspDS) loadMSP(); else setStatus('Zonasi MSP aktif.');
    }else{
      clearMSP();
    }
  }

  // ——— Start ———
  boot();
})();
</script>
</body>
</html>
